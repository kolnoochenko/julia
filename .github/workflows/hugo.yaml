name: Deploy Hugo site to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true
      - name: Build
        run: hugo --minify
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      - name: Send Telegram Notification
        if: success()
        run: |
          # 1. –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ñ–∞–π–ª, —è–∫–∏–π –∑–º—ñ–Ω–∏–≤—Å—è (—à—É–∫–∞—î–º–æ .md —Ñ–∞–π–ª —É –ø–∞–ø—Ü—ñ content)
          CHANGED_FILE=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep "content/.*\.md$" | head -n 1)

          # 2. –í–∏—Ç—è–≥—É—î–º–æ –∑ –Ω—å–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (Title)
          if [ -n "$CHANGED_FILE" ] && [ -f "$CHANGED_FILE" ]; then
              # –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Ä—è–¥–æ–∫ title:, –≤–∏–¥–∞–ª—è—î–º–æ —Å–∞–º–µ —Å–ª–æ–≤–æ —ñ –ª–∞–ø–∫–∏
              POST_TITLE=$(grep "^title:" "$CHANGED_FILE" | sed 's/^title:[[:space:]]*//' | tr -d '"' | tr -d "'")
          else
              # –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ —Ñ–∞–π–ª (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏ –ø—Ä–∞–≤–∏–ª–∏ —Ç—ñ–ª—å–∫–∏ –∫–æ–Ω—Ñ—ñ–≥), –±–µ—Ä–µ–º–æ —Ç–µ–∫—Å—Ç –∫–æ–º—ñ—Ç—É
              POST_TITLE="${{ github.event.head_commit.message }}"
          fi

          # 3. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –≤ –¢–µ–ª–µ–≥—Ä–∞–º (URL –∑–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ —Å–≤—ñ–π!)
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=HTML \
          -d text="üíå <b>–ù–æ–≤–∏–π –∑–∞–ø–∏—Å!</b>
          
          üìù –¢–µ–º–∞: $POST_TITLE
          
          https://for-my-sunshine.com.ua/secret-view-A1B2/"
