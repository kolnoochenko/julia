name: Deploy Hugo site to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # –†–æ–±–æ—Ç–∞ –∑—ñ –∑–±—ñ—Ä–∫–∏ —Å–∞–π—Ç—É
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true
      - name: Build
        run: hugo --minify
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # –†–æ–±–æ—Ç–∞ –∑ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó —Ç–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–æ–¥ —â–µ —Ä–∞–∑, —â–æ–± –º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó Git –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞
      - name: Checkout code for Telegram
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. –°–∫—Ä–∏–ø—Ç —Ä–æ–∑—É–º–Ω–æ–≥–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
      - name: Send Telegram Notification
        if: success()
        run: |
          echo "=== –ü–û–ß–ê–¢–û–ö –†–û–ë–û–¢–ò –°–ö–†–ò–ü–¢–ê ==="
          
          # –®—É–∫–∞—î–º–æ –∑–º—ñ–Ω–µ–Ω–∏–π md —Ñ–∞–π–ª –≤ –æ—Å—Ç–∞–Ω–Ω—å–æ–º—É –∫–æ–º—ñ—Ç—ñ
          # HEAD~1 HEAD –ø–æ—Ä—ñ–≤–Ω—é—î –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —ñ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω
          CHANGED_FILE=$(git diff --name-only HEAD~1 HEAD | grep "content/.*\.md$" | head -n 1)
          
          # –Ø–∫—â–æ —Ü–µ –ø–µ—Ä—à–∏–π –∫–æ–º—ñ—Ç –∞–±–æ diff –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–≤, –ø—Ä–æ–±—É—î–º–æ —ñ–Ω—à–∏–π –º–µ—Ç–æ–¥
          if [ -z "$CHANGED_FILE" ]; then
             CHANGED_FILE=$(git show --name-only --format= HEAD | grep "content/.*\.md$" | head -n 1)
          fi

          echo "–ó–Ω–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª: $CHANGED_FILE"

          if [ -n "$CHANGED_FILE" ]; then
              # --- –í–ê–†–Ü–ê–ù–¢ –ê: –ó–Ω–∞–π—à–ª–∏ –Ω–æ–≤–∏–π –ø–æ—Å—Ç ---
              echo "–û–±—Ä–æ–±–ª—è—î–º–æ –ø–æ—Å—Ç..."
              
              # 1. –í–∏—Ç—è–≥—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–≤–∏–¥–∞–ª—è—î–º–æ title: —ñ –ª–∞–ø–∫–∏)
              POST_TITLE=$(grep "^title:" "$CHANGED_FILE" | sed 's/^title:[[:space:]]*//' | tr -d '"' | tr -d "'")
              
              # 2. –§–æ—Ä–º—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (Slugify):
              # - –ü—Ä–∏–±–∏—Ä–∞—î–º–æ 'content/' –∑ –ø–æ—á–∞—Ç–∫—É —ñ –Ω–∞–∑–≤—É —Å–µ–∫—Ä–µ—Ç–Ω–æ—ó –ø–∞–ø–∫–∏ (—à–ª—è—Ö Hugo –±–µ—Ä–µ –≤—ñ–¥ –∫–æ—Ä–µ–Ω—è)
              # - –ü—Ä–∏–±–∏—Ä–∞—î–º–æ '.md' –∑ –∫—ñ–Ω—Ü—è
              # - –†–æ–±–∏–º–æ –≤—Å—ñ –±—É–∫–≤–∏ –º–∞–ª–µ–Ω—å–∫–∏–º–∏
              # - –ó–∞–º—ñ–Ω—é—î–º–æ –ø—Ä–æ–±—ñ–ª–∏ –Ω–∞ –¥–µ—Ñ—ñ—Å–∏
              SLUG=$(echo "$CHANGED_FILE" | sed 's/^content\///' | sed 's/\.md$//' | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')
              
              POST_LINK="https://for-my-sunshine.com.ua/$SLUG/"
              
              MESSAGE="üíå <b>–ù–æ–≤–∏–π –∑–∞–ø–∏—Å!</b>%0A%0Aüìù –¢–µ–º–∞: $POST_TITLE%0A%0A$POST_LINK"
          
          else
              # --- –í–ê–†–Ü–ê–ù–¢ –ë: –ü–æ—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–º—ñ–Ω–∏–ª–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è) ---
              echo "Markdown —Ñ–∞–π–ª—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–≥–∞–ª—å–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è."
              
              COMMIT_MSG="${{ github.event.head_commit.message }}"
              
              # !!! –í–ê–ñ–õ–ò–í–û: –ó–ê–ú–Ü–ù–Ü–¢–¨ secret-view-A1B2 –ù–ê –í–ê–®–£ –†–ï–ê–õ–¨–ù–£ –ü–ê–ü–ö–£ !!!
              MESSAGE="‚öôÔ∏è <b>–ë–ª–æ–≥ –æ–Ω–æ–≤–ª–µ–Ω–æ!</b>%0A%0A–ö–æ–º–µ–Ω—Ç–∞—Ä: $COMMIT_MSG%0A%0Aüëâ https://for-my-sunshine.com.ua/secret-view-A1B2/"
          fi

          echo "–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –≤ Telegram..."

          # –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ curl
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=HTML \
          -d text="$MESSAGE"
